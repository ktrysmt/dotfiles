#!/bin/zsh

current_path=$1
git_info=""

# Get current branch
git_branch=$(cd $current_path && git symbolic-ref --short HEAD 2>/dev/null)

if [[ "$git_branch" != "" ]]; then
  # Check if in a worktree
  git_dir=$(cd $current_path && git rev-parse --git-dir 2>/dev/null)
  if [[ "${git_dir}" == *"/worktrees/"* ]]; then
    # In a worktree - get main worktree's branch
    main_worktree=$(cd $current_path && git worktree list | head -1 | awk '{print $1}')
    main_branch=$(git -C "${main_worktree}" symbolic-ref --short HEAD 2>/dev/null)
    git_branch="${main_branch}|${git_branch}"
  fi

  g_status="$(cd $current_path && git status -s 2>/dev/null | sort -r)";
  if [[ $(echo $g_status | grep -c -E '^(UU|AA) ') > 0 ]]; then
    state="#[bg=red,fg=black] x #[fg=default]" ;
  elif [[ $(echo $g_status | grep -c -E "^(\?\?) ") > 0 ]]; then
    state="#[bg=red,fg=black] ? #[default]" ;
  elif [[ $(echo $g_status | grep -c -E '^( M|AM|MM|AD| D|\?\?) ') > 0 ]]; then
    state="#[bg=yellow,fg=black] * #[fg=default]" ;
  elif [[ $(echo $g_status | grep -c -E "^(M|A|D|R)  ") > 0 ]]; then
    state="#[bg=colour013,fg=black] + #[default]" ;
  else
    state="#[bg=green,fg=black] o #[default]" ;
  fi

  if [[ $git_branch != "master" ]]; then
    git_info="#[underscore]#[bg=black,fg=colour014] (${git_branch}) #[default]"
  else
    git_info="#[underscore]#[bg=black,fg=blue] (master) #[default]"
  fi

else
  git_info=""
fi

directory="#[underscore]#[bg=black,fg=cyan]$current_path#[default]"

echo "$directory$git_info$state"
